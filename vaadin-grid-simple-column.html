<!--
@license
Copyright (c) 2017 Vaadin Ltd.
This program is available under Apache License Version 2.0, available at https://vaadin.com/license/
-->

<link rel="import" href="../polymer/lib/utils/case-map.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="vaadin-grid-column.html">
<link rel="import" href="vaadin-grid-sorter.html">
<link rel="import" href="vaadin-grid-filter.html">
<link rel="import" href="vaadin-grid-tree-toggle.html">

<dom-module id="vaadin-grid-simple-column">
  <template>
    <template class="header" id="defaultHeaderTemplate">

      <template is="dom-if" if="[[_sortableFilterable(sortable, filterable, 'sortable')]]">
        <vaadin-grid-sorter path="[[path]]">[[_getTitle(title, path)]]</vaadin-grid-sorter>
      </template>

      <template is="dom-if" if="[[_sortableFilterable(sortable, filterable, 'filterable')]]">
        <vaadin-grid-filter path="[[path]]" value="[[_filterValue]]">
          <vaadin-text-field id="filter" slot="filter" value="{{_filterValue}}" placeholder="[[_getTitle(title, path)]]"></vaadin-text-field>
        </vaadin-grid-filter>
      </template>

      <template is="dom-if" if="[[_sortableFilterable(sortable, filterable, 'both')]]">
        <vaadin-grid-sorter path="[[path]]">
          <vaadin-grid-filter path="[[path]]" value="[[_filterValue]]">
            <vaadin-text-field id="filter" slot="filter" value="{{_filterValue}}" placeholder="[[_getTitle(title, path)]]"></vaadin-text-field>
          </vaadin-grid-filter>
        </vaadin-grid-sorter>
      </template>
      
      <template is="dom-if" if="[[_sortableFilterable(sortable, filterable, 'neither')]]">[[_getTitle(title, path)]]</template>

    </template>

    <template id="defaultBodyTemplate">

      <template is="dom-if" if="[[expandable]]">
        <vaadin-grid-tree-toggle leaf="[[!item.children.length]]" expanded="{{expanded}}" level="[[level]]">
          [[get(path, item)]]
        </vaadin-grid-tree-toggle>
      </template>

      <template is="dom-if" if="[[!expandable]]">[[get(path, item)]]</template>
    </template>
  </template>

  <script>
  {
    /**
     * @memberof Vaadin
     * @mixes Vaadin.GridColumnElement
     */
    class GridSimpleColumnElement extends Vaadin.GridColumnElement {

      static get is() {
        return 'vaadin-grid-simple-column';
      }

      static get properties() {
        return {
          /**
           * Width of the cells for this column.
           */
          title: {
            type: String,
            value: ''
          },

          path: {
            type: String,
            value: ''
          },

          sortable: {
            type: Boolean,
            value: false
          },

          filterable: {
            type: Boolean,
            value: false
          },

          expandable: {
            type: Boolean,
            value: false
          }
        };
      }

      _prepareHeaderTemplate() {
        const headerTemplate = this._prepareTemplatizer(this._findTemplate('template.header') || this.$.defaultHeaderTemplate);
        // needed to override the dataHost correctly in case internal template is used.
        headerTemplate.templatizer.dataHost = headerTemplate === this.$.defaultHeaderTemplate ? this : this.dataHost;

        return headerTemplate;
      }

      _prepareBodyTemplate() {
        const template = this._prepareTemplatizer(this._findTemplate('template:not(.header):not(.footer)') || this.$.defaultBodyTemplate);
        // needed to override the dataHost correctly in case internal template is used.
        template.templatizer.dataHost = template === this.$.defaultBodyTemplate ? this : this.dataHost;

        return template;
      }

      _getTitle(title, path) {
        if (title) {
          return title;
        } else if (path) {
          const propertyName = path.substr(path.lastIndexOf('.') + 1);
          return Polymer.CaseMap.camelToDashCase(propertyName)
            .replace(/-/, ' ')
            .replace(/\w\S*/g, str => str.charAt(0).toUpperCase() + str.substr(1));
        }
      }

      _sortableFilterable(sortable, filterable, condition) {
        if (condition === 'sortable') {
          return sortable && !filterable;
        } else if (condition === 'filterable') {
          return !sortable && filterable;
        } else if (condition === 'both') {
          return sortable && filterable;
        } else if (condition === 'neither') {
          return !sortable && !filterable;
        }
      }

    }

    customElements.define(GridSimpleColumnElement.is, GridSimpleColumnElement);

    /**
     * @namespace Vaadin
     */
    window.Vaadin = window.Vaadin || {};
    Vaadin.GridSimpleColumnElement = GridSimpleColumnElement;
  }
  </script>
</dom-module>
